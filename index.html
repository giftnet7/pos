<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesh cafe and Restaurant</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .container {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                height: 90vh; /* Adjust height for larger screens */
            }
        }
        .scrollable-content {
            overflow-y: auto;
            flex-grow: 1;
        }
        /* Custom scrollbar for better aesthetics */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Modal styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.5rem;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 0 10px rgba(0,0,0,0.25);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container bg-white rounded-xl shadow-lg md:flex md:h-[90vh] overflow-hidden">
        <!-- Navigation Panel -->
        <div class="w-full md:w-1/5 bg-gray-800 text-white p-4 flex flex-col justify-between rounded-t-xl md:rounded-l-xl md:rounded-tr-none">
            <div>
                <h1 class="text-2xl font-bold mb-6 text-center">Tesh cafe and Restaurant</h1>
                <nav>
                    <!-- Nav buttons are initially hidden, shown after login -->
                    <button id="pos-nav-btn" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200 mb-2 hidden">
                        <i class="fas fa-cash-register mr-2"></i> Cashier
                    </button>
                    <button id="admin-nav-btn" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200 mb-2 hidden">
                        <i class="fas fa-user-cog mr-2"></i> Admin Panel
                    </button>
                </nav>
            </div>
            <div class="mt-auto text-sm text-gray-400 text-center">
                <p>Logged in as: <span id="current-user-id">Not logged in</span></p>
                <button id="logout-btn" class="w-full text-left py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 transition-colors duration-200 mt-4 text-white hidden">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
                <p class="mt-2">&copy; Tesh cafe and Restaurant</p>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 p-6 scrollable-content">
            <!-- Home/Login Section -->
            <div id="home-page-section" class="flex flex-col items-center justify-center h-full">
                <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md text-center">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Welcome to tesh cafe</h2>
                    <p class="text-gray-600 mb-8">Please log in to continue.</p>

                    <div class="space-y-4">
                        <div>
                            <label for="user-select" class="sr-only">Select User</label>
                            <select id="user-select" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-lg">
                                <option value="">-- Select User --</option>
                                <option value="cashier">Cashier</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div>
                            <label for="password-input" class="sr-only">Password</label>
                            <input type="password" id="password-input" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-lg">
                        </div>
                        <button id="login-btn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors duration-200 font-bold text-lg shadow-md">
                            Login
                        </button>
                    </div>
                    <p id="login-error-message" class="text-red-500 text-sm mt-4 hidden">Invalid username or password.</p>
                </div>
            </div>

            <!-- POS Section -->
            <div id="pos-section" class="flex flex-col md:flex-row gap-6 hidden">
                <!-- Menu and Categories -->
                <div class="w-full md:w-3/5 bg-gray-50 p-4 rounded-lg shadow-inner flex flex-col">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Menu</h2>
                    <!-- Category Tabs -->
                    <div id="categories-container" class="flex flex-wrap gap-2 mb-4">
                        <!-- Categories will be loaded here by JS -->
                    </div>
                    <!-- Items Grid -->
                    <div id="items-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 flex-grow overflow-y-auto pr-2">
                        <!-- Items will be loaded here by JS -->
                    </div>
                </div>

                <!-- Order Cart -->
                <div class="w-full md:w-2/5 bg-white p-4 rounded-lg shadow-md flex flex-col">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Current Order</h2>
                    <div id="order-list" class="flex-grow overflow-y-auto mb-4 border-b border-gray-200 pb-4">
                        <!-- Order items will be loaded here by JS -->
                        <p id="empty-order-message" class="text-gray-500 text-center py-8">No items in order yet.</p>
                    </div>

                    <!-- Order Summary -->
                    <div class="space-y-2 text-gray-700 font-medium text-lg mb-6">
                        <div class="flex justify-between"><span>Subtotal:</span><span id="subtotal">$0.00</span></div>
                        <div class="flex justify-between"><span>Tax (8%):</span><span id="tax-amount">$0.00</span></div>
                        <div class="flex justify-between text-2xl font-bold text-gray-900"><span>Total:</span><span id="grand-total">$0.00</span></div>
                    </div>

                    <!-- Payment Section - Cash Tendered removed -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h3 class="text-xl font-semibold mb-3 text-gray-800">Payment</h3>
                        <div class="flex gap-2">
                            <button id="process-payment-btn" class="flex-1 bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200 font-bold text-lg shadow-md">
                                Save Payment
                            </button>
                            <button id="cancel-order-btn" class="flex-1 bg-red-500 text-white py-3 px-4 rounded-lg hover:bg-red-600 transition-colors duration-200 font-bold text-lg shadow-md">
                                Cancel Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Section -->
            <div id="admin-section" class="hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Admin Panel</h2>

                <!-- Admin Tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-4">
                        <button id="manage-items-tab" class="py-2 px-4 text-lg font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-blue-500 transition-colors duration-200">
                            Manage Items
                        </button>
                        <button id="manage-categories-tab" class="py-2 px-4 text-lg font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-blue-500 transition-colors duration-200">
                            Manage Categories
                        </button>
                        <button id="sales-history-tab" class="py-2 px-4 text-lg font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-blue-500 transition-colors duration-200">
                            Sales Report
                        </button>
                    </nav>
                </div>

                <!-- Manage Items Sub-section -->
                <div id="manage-items-section" class="bg-gray-50 p-6 rounded-lg shadow-md">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Manage Menu Items</h3>

                    <!-- Add New Item Form -->
                    <div class="mb-8 p-4 bg-white rounded-lg shadow-sm">
                        <h4 class="text-xl font-semibold mb-3 text-gray-700">Add New Item</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="new-item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                                <input type="text" id="new-item-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="new-item-price" class="block text-sm font-medium text-gray-700">Price ($)</label>
                                <input type="number" id="new-item-price" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" min="0.01" step="0.01">
                            </div>
                            <div>
                                <label for="new-item-category" class="block text-sm font-medium text-gray-700">Category</label>
                                <select id="new-item-category" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <!-- Categories will be dynamically loaded here -->
                                </select>
                            </div>
                        </div>
                        <button id="add-item-btn" class="mt-4 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors duration-200 shadow-sm">
                            Add Item
                        </button>
                    </div>

                    <!-- Existing Items List -->
                    <h4 class="text-xl font-semibold mb-3 text-gray-700">Existing Items</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Item Name</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Category</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Price</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-items-list" class="divide-y divide-gray-200">
                                <!-- Items will be loaded here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Manage Categories Sub-section -->
                <div id="manage-categories-section" class="bg-gray-50 p-6 rounded-lg shadow-md hidden">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Manage Categories</h3>

                    <!-- Add New Category Form -->
                    <div class="mb-8 p-4 bg-white rounded-lg shadow-sm">
                        <h4 class="text-xl font-semibold mb-3 text-gray-700">Add New Category</h4>
                        <div class="flex gap-4">
                            <input type="text" id="new-category-name" placeholder="Category Name" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <button id="add-category-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors duration-200 shadow-sm">
                                Add Category
                            </button>
                        </div>
                    </div>

                    <!-- Existing Categories List -->
                    <h4 class="text-xl font-semibold mb-3 text-gray-700">Existing Categories</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Category Name</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-categories-list" class="divide-y divide-gray-200">
                                <!-- Categories will be loaded here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sales History Sub-section -->
                <div id="sales-history-section" class="hidden bg-gray-50 p-6 rounded-lg shadow-md">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Sales History</h3>

                    <!-- Filters and PDF Export Button -->
                    <div class="mb-4 p-4 bg-white rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="history-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="history-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="history-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="history-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="history-cashier-filter" class="block text-sm font-medium text-gray-700">Cashier ID</label>
                            <input type="text" id="history-cashier-filter" placeholder="Filter by User ID" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <button id="apply-history-filter-btn" class="md:col-span-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors duration-200 shadow-sm">
                            Apply Filters
                        </button>
                        <button id="export-pdf-btn" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition-colors duration-200 shadow-sm">
                            <i class="fas fa-file-pdf mr-2"></i> Save to PDF
                        </button>
                        <button id="clear-sales-history-btn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors duration-200 shadow-sm">
                            <i class="fas fa-trash-alt mr-2"></i> Clear Sales History
                        </button>
                    </div>

                    <!-- Total Sales Display -->
                    <div class="mt-4 mb-8 p-4 bg-white rounded-lg shadow-sm">
                        <h4 class="text-xl font-semibold mb-3 text-gray-700">Total Sales</h4>
                        <p id="total-sales-display" class="text-3xl font-bold text-green-700 text-center">$0.00</p>
                    </div>

                    <!-- Sales Transactions Table -->
                    <div class="overflow-x-auto mb-8">
                        <h4 class="text-xl font-semibold mb-3 text-gray-700">Sales Transactions</h4>
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Date</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Total</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Items</th>
                                </tr>
                            </thead>
                            <tbody id="sales-history-list" class="divide-y divide-gray-200">
                                <!-- Sales history will be loaded here by JS -->
                                <tr><td colspan="3" class="text-center py-4 text-gray-500">No sales transactions yet.</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Sales Summary by Item Table (updated) -->
                    <div class="mt-8 p-4 bg-white rounded-lg shadow-sm">
                        <h4 class="text-xl font-semibold mb-3 text-gray-700">Total sales by Item</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Item Name</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Total Sold</th>
                                    </tr>
                                </thead>
                                <tbody id="item-sales-summary-list" class="divide-y divide-gray-200">
                                    <!-- Item sales summary will be loaded here by JS -->
                                    <tr><td colspan="2" class="text-center py-4 text-gray-500">No item sales data.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="message-modal" class="modal">
        <div class="modal-content text-center">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800"></h3>
            <p id="modal-message" class="text-lg text-gray-700 mb-6"></p>
            <button id="modal-close-btn" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-200 font-semibold shadow-md">OK</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content text-center">
            <h3 id="confirm-modal-title" class="text-2xl font-bold mb-4 text-gray-800">Confirm Action</h3>
            <p id="confirm-modal-message" class="text-lg text-gray-700 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-yes-btn" class="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700 transition-colors duration-200 font-semibold shadow-md">Yes</button>
                <button id="confirm-modal-no-btn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-400 transition-colors duration-200 font-semibold shadow-md">No</button>
            </div>
        </div>
    </div>

    <!-- New Prompt Modal for Admin Password (still defined but not used for initial admin login) -->
    <div id="prompt-modal" class="modal">
        <div class="modal-content text-center">
            <h3 id="prompt-modal-title" class="text-2xl font-bold mb-4 text-gray-800"></h3>
            <p id="prompt-modal-message" class="text-lg text-gray-700 mb-4"></p>
            <input type="password" id="prompt-modal-input" class="w-full p-2 border border-gray-300 rounded-md mb-6 text-center" placeholder="Enter password">
            <div class="flex justify-center gap-4">
                <button id="prompt-modal-ok-btn" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-200 font-semibold shadow-md">OK</button>
                <button id="prompt-modal-cancel-btn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-400 transition-colors duration-200 font-semibold shadow-md">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // --- Feature Flag for Local Storage vs. Firebase ---
        const USE_LOCAL_STORAGE = true; // Set to true to use Local Storage, false to use Firebase

        // Admin and Cashier Passwords
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = '810012';
        const CASHIER_USERNAME = 'cashier';
        const CASHIER_PASSWORD = '1234';

        // Firebase imports (only used if USE_LOCAL_STORAGE is false)
        let initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged;
        let getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs;

        // Make jsPDF and html2canvas available globally or import if needed
        const { jsPDF } = window.jspdf;

        if (!USE_LOCAL_STORAGE) {
            import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js")
                .then(module => { initializeApp = module.initializeApp; })
                .catch(err => console.error("Failed to load firebase-app.js:", err));

            import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js")
                .then(module => {
                    getAuth = module.getAuth;
                    signInAnonymously = module.signInAnonymously;
                    signInWithCustomToken = module.signInWithCustomToken;
                    onAuthStateChanged = module.onAuthStateChanged;
                })
                .catch(err => console.error("Failed to load firebase-auth.js:", err));

            import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js")
                .then(module => {
                    getFirestore = module.getFirestore;
                    doc = module.doc;
                    getDoc = module.getDoc;
                    addDoc = module.addDoc;
                    setDoc = module.setDoc;
                    updateDoc = module.updateDoc;
                    deleteDoc = module.deleteDoc;
                    onSnapshot = module.onSnapshot;
                    collection = module.collection;
                    query = module.query;
                    where = module.where;
                    getDocs = module.getDocs;
                })
                .catch(err => console.error("Failed to load firebase-firestore.js:", err));
        }

        // Global Firebase variables (to be used after initialization, only if USE_LOCAL_STORAGE is false)
        let app;
        let db;
        let auth;

        // User ID and Role for data partitioning (Local Storage or Firebase)
        let userId;
        let userRole = 'guest'; // 'guest', 'cashier', 'admin'

        // Firebase project configuration (ONLY USED IF USE_LOCAL_STORAGE IS FALSE)
        const firebaseConfig = {
            apiKey: "AIzaSyA87PgKCrndm0I-T1ylM92P1BAvuFXhZiE",
            authDomain: "posm-15b06.firebaseapp.com",
            projectId: "posm-15b06",
            storageBucket: "posm-15b06.firebasestorage.app",
            messagingSenderId: "263213398697",
            appId: "1:263213398697:web:bc495de23540530ca647b8",
            measurementId: "G-EPCXB4LLZY"
        };

        // Local storage keys (ONLY USED IF USE_LOCAL_STORAGE IS TRUE)
        let LOCAL_STORAGE_CATEGORIES_KEY;
        let LOCAL_STORAGE_ITEMS_KEY;
        let LOCAL_STORAGE_SALES_HISTORY_KEY;

        // In-memory data stores for the UI
        let categories = [];
        let items = [];
        let salesHistory = [];
        let currentOrder = [];
        const TAX_RATE = 0.08; // 8% tax

        // Default menu items for initial seeding (both Local Storage and Firebase)
        const DEFAULT_CATEGORIES = [
            { name: 'burger' }, { name: 'pizza' }, { name: 'break fast' },
            { name: 'traditional food' }, { name: 'pasta' }, { name: 'hot drink' },
            { name: 'cake' }, { name: 'drink' }, { name: 'takeaway' }
        ];

        const DEFAULT_ITEMS = [
            { name: 'special burger', price: 300, category: 'burger', image: 'https://www.foodandwine.com/thmb/UNC3v0GAxDfbBUlBPg69uwv0tSk=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc():format(webp)/crispy-comte-cheesburgers-FT-RECIPE0921-6166c6552b7148e8a8561f7765ddf20b.jpg' },
            { name: 'cheese burger', price: 250, category: 'burger', image: 'https://www.foodandwine.com/thmb/UNC3v0GAxDfbBUlBPg69uwv0tSk=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc():format(webp)/crispy-comte-cheesburgers-FT-RECIPE0921-6166c6552b7148e8a8561f7765ddf20b.jpg' },
            { name: 'beef burger', price: 200, category: 'burger', image: 'https://www.foodandwine.com/thmb/UNC3v0GAxDfbBUlBPg69uwv0tSk=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc():format(webp)/crispy-comte-cheesburgers-FT-RECIPE0921-6166c6552b7148e8a8561f7765ddf20b.jpg' },
            { name: 'tesh special Pizza', price: 500, category: 'pizza', image: 'https://ooni.com/cdn/shop/articles/20220211142347-margherita-9920_ba86be55-674e-4f35-8094-2067ab41a671.jpg?v=1737104576&width=1080' },
            { name: 'special pizza', price: 450, category: 'pizza', image: 'https://ooni.com/cdn/shop/articles/20220211142347-margherita-9920_ba86be55-674e-4f35-8094-2067ab41a671.jpg?v=1737104576&width=1080' },
            { name: 'tuna pizza', price: 400, category: 'pizza', image: 'https://ooni.com/cdn/shop/articles/20220211142347-margherita-9920_ba86be55-674e-4f35-8094-2067ab41a671.jpg?v=1737104576&width=1080' },
            { name: 'club sandwich', price: 300, category: 'pizza', image: '' },
            { name: 'scramble egg', price: 120, category: 'break fast', image: '' },
            { name: 'egg sandwich', price: 120, category: 'break fast', image: '' },
            { name: 'qinca', price: 150, category: 'break fast', image: '' },
            { name: 'full', price: 150, category: 'break fast', image: '' },
            { name: 'fasting firfir', price: 120, category: 'traditional food', image: '' },
            { name: 'beef firfir', price: 200, category: 'traditional food', image: '' },
            { name: 'quanta firfir', price: 250, category: 'traditional food', image: '' },
            { name: 'combo', price: 400, category: 'traditional food', image: '' },
            { name: 'shiro', price: 150, category: 'traditional food', image: '' },
            { name: 'beef felate', price: 300, category: 'traditional food', image: '' },
            { name: 'goat tebes', price: 300, category: 'traditional food', image: '' },
            { name: 'zelzel tebes', price: 300, category: 'traditional food', image: '' },
            { name: 'pasta with tomato', price: 150, category: 'pasta', image: '' },
            { name: 'pasta with meat', price: 200, category: 'pasta', image: '' },
            { name: 'tea', price: 25, category: 'hot drink', image: '' },
            { name: 'milk', price: 50, category: 'hot drink', image: '' },
            { name: 'flavor tea', price: 50, category: 'hot drink', 'image': '' },
            { name: 'special tea', price: 60, category: 'hot drink', image: '' },
            { name: 'coffee', price: 25, category: 'hot drink', image: '' },
            { name: 'tiramisu', price: 80, category: 'cake', image: '' },
            { name: 'cake', price: 80, category: 'cake', image: '' },
            { name: 'ice cream', price: 70, category: 'cake', image: '' },
            { name: 'pancake', price: 200, category: 'cake', image: '' },
            { name: 'macchiato', price: 40, category: 'cake', image: '' },
            { name: 'coca', price: 35, category: 'drink', image: '' },
            { name: 'fanta', price: 35, category: 'drink', image: '' },
            { name: 'mirinda', price: 35, category: 'drink', image: '' },
            { name: 'sprite', price: 35, category: 'drink', image: '' },
            { name: 'pepsi', price: 35, category: 'drink', image: '' },
            { name: 'sofi', price: 40, category: 'drink', image: '' },
            { name: '7 up', price: 35, category: 'drink', image: '' },
            { name: 'sheweps', price: 40, category: 'drink', image: '' },
            { name: '0.5L water', price: 25, category: 'drink', image: '' },
            { name: '1L water', price: 35, category: 'drink', image: '' },
            { name: 'pizza box', price: 30, category: 'takeaway', image: '' },
            { name: 'foil 20', price: 20, category: 'takeaway', image: '' },
            { name: 'foil 40', price: 40, category: 'takeaway', image: '' },
            { name: 'cake bex', price: 30, category: 'takeaway', image: '' },
            { name: 'cup', price: 15, category: 'takeaway', image: '' },
            { name: 'cup', price: 20, category: 'takeaway', image: '' }
        ];


        // DOM Elements
        const homePageSection = document.getElementById('home-page-section');
        const userSelect = document.getElementById('user-select'); // Changed from usernameInput
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const loginErrorMessage = document.getElementById('login-error-message');

        const posSection = document.getElementById('pos-section');
        const adminSection = document.getElementById('admin-section');
        const posNavBtn = document.getElementById('pos-nav-btn');
        const adminNavBtn = document.getElementById('admin-nav-btn');
        const logoutBtn = document.getElementById('logout-btn'); // New logout button
        const categoriesContainer = document.getElementById('categories-container');
        const itemsGrid = document.getElementById('items-grid');
        const orderList = document.getElementById('order-list');
        const emptyOrderMessage = document.getElementById('empty-order-message');
        const subtotalElem = document.getElementById('subtotal');
        const taxAmountElem = document.getElementById('tax-amount');
        const grandTotalElem = document.getElementById('grand-total');
        const processPaymentBtn = document.getElementById('process-payment-btn');
        const cancelOrderBtn = document.getElementById('cancel-order-btn');

        // Admin DOM Elements
        const manageItemsTab = document.getElementById('manage-items-tab');
        const manageCategoriesTab = document.getElementById('manage-categories-tab');
        const salesHistoryTab = document.getElementById('sales-history-tab');
        const manageItemsSection = document.getElementById('manage-items-section');
        const manageCategoriesSection = document.getElementById('manage-categories-section');
        const salesHistorySection = document.getElementById('sales-history-section');

        const newItemNameInput = document.getElementById('new-item-name');
        const newItemPriceInput = document.getElementById('new-item-price');
        const newItemCategorySelect = document.getElementById('new-item-category');
        const addItemBtn = document.getElementById('add-item-btn');
        const adminItemsList = document.getElementById('admin-items-list');

        const newCategoryNameInput = document.getElementById('new-category-name');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const adminCategoriesList = document.getElementById('admin-categories-list');

        const salesHistoryList = document.getElementById('sales-history-list');
        const historyStartDateInput = document.getElementById('history-start-date');
        const historyEndDateInput = document.getElementById('history-end-date');
        const historyCashierFilterInput = document.getElementById('history-cashier-filter');
        const applyHistoryFilterBtn = document.getElementById('apply-history-filter-btn');
        const totalSalesDisplay = document.getElementById('total-sales-display');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const clearSalesHistoryBtn = document.getElementById('clear-sales-history-btn');
        const itemSalesSummaryList = document.getElementById('item-sales-summary-list');


        // Modals
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmModalYesBtn = document.getElementById('confirm-modal-yes-btn');
        const confirmModalNoBtn = document.getElementById('confirm-modal-no-btn');

        const promptModal = document.getElementById('prompt-modal');
        const promptModalTitle = document.getElementById('prompt-modal-title');
        const promptModalMessage = document.getElementById('prompt-modal-message');
        const promptModalInput = document.getElementById('prompt-modal-input');
        const promptModalOkBtn = document.getElementById('prompt-modal-ok-btn');
        const promptModalCancelBtn = document.getElementById('prompt-modal-cancel-btn');


        // Global variable for confirm/prompt modal resolution
        let confirmModalResolve;
        let promptModalResolve;

        /**
         * Shows a custom message modal.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message content.
         */
        function showMessageModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
        }

        /**
         * Shows a custom confirmation modal.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message content.
         * @returns {Promise<boolean>} A promise that resolves to true if 'Yes' is clicked, false otherwise.
         */
        function showConfirmModal(title, message) {
            confirmModalTitle.textContent = title;
            confirmModalMessage.textContent = message;
            confirmModal.style.display = 'flex';

            return new Promise(resolve => {
                confirmModalResolve = resolve;
            });
        }

        /**
         * Shows a custom prompt modal with an input field.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message content.
         * @param {string} [placeholder=''] - Placeholder text for the input.
         * @param {string} [inputType='text'] - Type of the input field (e.g., 'text', 'password').
         * @returns {Promise<string|null>} A promise that resolves with the entered text or null if canceled.
         */
        function showPromptModal(title, message, placeholder = '', inputType = 'text') {
            promptModalTitle.textContent = title;
            promptModalMessage.textContent = message;
            promptModalInput.placeholder = placeholder;
            promptModalInput.type = inputType;
            promptModalInput.value = ''; // Clear previous input
            promptModal.style.display = 'flex';
            promptModalInput.focus(); // Focus the input field

            return new Promise(resolve => {
                promptModalResolve = resolve;
            });
        }

        // Event listeners for modals
        modalCloseBtn.addEventListener('click', () => {
            messageModal.style.display = 'none';
        });

        confirmModalYesBtn.addEventListener('click', () => {
            confirmModal.style.display = 'none';
            if (confirmModalResolve) confirmModalResolve(true);
        });

        confirmModalNoBtn.addEventListener('click', () => {
            confirmModal.style.display = 'none';
            if (confirmModalResolve) confirmModalResolve(false);
        });

        promptModalOkBtn.addEventListener('click', () => {
            promptModal.style.display = 'none';
            if (promptModalResolve) promptModalResolve(promptModalInput.value);
        });

        promptModalCancelBtn.addEventListener('click', () => {
            promptModal.style.display = 'none';
            if (promptModalResolve) promptModalResolve(null);
        });

        promptModalInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                promptModalOkBtn.click();
            }
        });


        // --- Initialization and Data Loading ---
        window.onload = async function() {
            try {
                // Determine appId (for local storage keys or Firebase path)
                let currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                // Initialize local storage keys based on appId
                LOCAL_STORAGE_CATEGORIES_KEY = `pos_categories_${currentAppId}`;
                LOCAL_STORAGE_ITEMS_KEY = `pos_items_${currentAppId}`;
                LOCAL_STORAGE_SALES_HISTORY_KEY = `pos_sales_history_${currentAppId}`;

                if (USE_LOCAL_STORAGE) {
                    userId = localStorage.getItem('pos_user_id') || 'unauthenticated';
                    document.getElementById('current-user-id').textContent = userId + " (Local)";
                    console.log("Using Local Storage. Initial User ID:", userId);

                    loadCategories();
                    loadItems();
                    loadSalesHistory();
                    
                    await seedInitialData();
                    // Initial rendering is handled after login, so don't call renderCategories/Items/Order here.
                    
                    // Show home page initially
                    showSection('home');

                } else {
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    console.log("App ID:", currentAppId);
                    console.log("Firebase Config (directly embedded):", firebaseConfig);

                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    console.log("Firebase App, DB, Auth initialized.");

                    if (auth) {
                        onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                userId = user.uid;
                                document.getElementById('current-user-id').textContent = userId;
                                console.log("User authenticated:", userId);
                                setupFirestoreListeners(currentAppId);
                                await seedInitialData(currentAppId);
                                showSection('home'); // Still show home page, user must log in
                            } else {
                                userId = crypto.randomUUID();
                                document.getElementById('current-user-id').textContent = userId + " (Anonymous)";
                                console.warn("Authentication Failed or Anonymous User:", userId);
                                showMessageModal("Authentication Failed", "Could not authenticate with Firebase. Proceeding as anonymous user. Please ensure Firebase Security Rules allow anonymous access if needed.");
                                setupFirestoreListeners(currentAppId);
                                showSection('home'); // Still show home page
                            }
                        });
                    } else {
                        showMessageModal("Initialization Error", "Firebase authentication service is not available.");
                        console.error("Firebase authentication service is not available.");
                        return;
                    }

                    if (initialAuthToken) {
                        console.log("Attempting sign-in with custom token...");
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (customTokenError) {
                            console.warn("Custom token sign-in failed:", customTokenError);
                            console.log("Falling back to anonymous sign-in...");
                            await signInAnonymously(auth);
                        }
                    } else {
                        console.log("Attempting anonymous sign-in...");
                        await signInAnonymously(auth);
                    }
                }

            } catch (error) {
                console.error("Error initializing application:", error);
                showMessageModal("Initialization Error", "Failed to initialize the application. Please check console for details.");
            }
        };

        // --- Local Storage Data Management Functions ---

        function loadCategories() {
            const storedCategories = localStorage.getItem(LOCAL_STORAGE_CATEGORIES_KEY);
            categories = storedCategories ? JSON.parse(storedCategories) : [];
        }

        function saveCategories() {
            localStorage.setItem(LOCAL_STORAGE_CATEGORIES_KEY, JSON.stringify(categories));
        }

        function loadItems() {
            const storedItems = localStorage.getItem(LOCAL_STORAGE_ITEMS_KEY);
            items = storedItems ? JSON.parse(storedItems) : [];
        }

        function saveItems() {
            localStorage.setItem(LOCAL_STORAGE_ITEMS_KEY, JSON.stringify(items));
        }

        function loadSalesHistory() {
            const storedHistory = localStorage.getItem(LOCAL_STORAGE_SALES_HISTORY_KEY);
            salesHistory = storedHistory ? JSON.parse(storedHistory) : [];
            // Convert timestamp strings back to Date objects for filtering
            salesHistory.forEach(sale => {
                if (typeof sale.timestamp === 'string') {
                    sale.timestamp = new Date(sale.timestamp);
                }
            });
        }

        function saveSalesHistory() {
            localStorage.setItem(LOCAL_STORAGE_SALES_HISTORY_KEY, JSON.stringify(salesHistory));
        }

        // --- Firebase Real-time Listeners (only if USE_LOCAL_STORAGE is false) ---

        /**
         * Sets up real-time listeners for Firebase data.
         * This function should be called ONLY after Firebase is initialized and authenticated.
         * @param {string} currentAppId - The appId provided by the environment.
         */
        function setupFirestoreListeners(currentAppId) {
            if (!db) {
                console.error("Firestore DB not initialized. Cannot set up listeners.");
                showMessageModal("Data Error", "Database not ready. Cannot load data.");
                return;
            }

            // Listener for Categories
            onSnapshot(collection(db, `artifacts/${currentAppId}/public/data/categories`), (snapshot) => {
                categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Categories loaded:", categories.length);
                if (userRole !== 'guest') { // Only re-render if logged in
                    renderCategories();
                    renderAdminCategories();
                    populateNewItemCategorySelect();
                }
            }, (error) => {
                console.error("Error fetching categories:", error);
                showMessageModal("Data Error", "Failed to load categories. Please check Firebase Security Rules.");
            });

            // Listener for Items
            onSnapshot(collection(db, `artifacts/${currentAppId}/public/data/items`), (snapshot) => {
                items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Items loaded:", items.length);
                if (userRole !== 'guest') { // Only re-render if logged in
                    renderItems();
                    renderAdminItems();
                }
            }, (error) => {
                console.error("Error fetching items:", error);
                showMessageModal("Data Error", "Failed to load menu items. Please check Firebase Security Rules.");
            });

            // Listener for Sales History
            onSnapshot(collection(db, `artifacts/${currentAppId}/public/data/salesHistory`), (snapshot) => {
                salesHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Sales history loaded:", salesHistory.length);
                if (userRole === 'admin') { // Only re-render sales history if admin
                    renderSalesHistory();
                }
            }, (error) => {
                console.error("Error fetching sales history:", error);
                showMessageModal("Data Error", "Failed to load sales history. Please check Firebase Security Rules.");
            });
        }


        // --- UI Rendering Functions (POS) ---

        /**
         * Renders category buttons based on the `categories` array.
         */
        function renderCategories() {
            categoriesContainer.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-button px-4 py-2 rounded-md bg-blue-100 text-blue-800 font-semibold hover:bg-blue-200 transition-colors duration-200 text-sm md:text-base';
                button.textContent = category.name;
                button.dataset.categoryId = category.id;
                button.addEventListener('click', () => filterItemsByCategory(category.id));
                categoriesContainer.appendChild(button);
            });
            // Add an "All" category button
            const allButton = document.createElement('button');
            allButton.className = 'category-button px-4 py-2 rounded-md bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors duration-200 text-sm md:text-base';
            allButton.textContent = 'All';
            allButton.addEventListener('click', () => renderItems()); // Render all items
            categoriesContainer.prepend(allButton); // Put 'All' at the beginning
        }

        /**
         * Renders menu items. Filters by category if `categoryId` is provided.
         * @param {string} [categoryId] - Optional category ID to filter items.
         */
        function renderItems(categoryId = null) {
            itemsGrid.innerHTML = '';
            let filteredItems = categoryId ? items.filter(item => item.categoryId === categoryId) : items;

            if (filteredItems.length === 0) {
                itemsGrid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">No items found for this category.</p>';
                return;
            }

            filteredItems.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow duration-200 flex flex-col items-center text-center';
                itemCard.innerHTML = `
                    <h3 class="text-md font-semibold text-gray-800 mb-1">${item.name}</h3>
                    <p class="text-xl font-bold text-green-600">$${item.price.toFixed(2)}</p>
                `;
                itemCard.addEventListener('click', () => addItemToOrder(item));
                itemsGrid.appendChild(itemCard);
            });
        }

        /**
         * Filters items displayed in the POS grid by the selected category.
         * Also visually highlights the active category button.
         * @param {string} categoryId - The ID of the category to filter by.
         */
        function filterItemsByCategory(categoryId) {
            // Remove active class from all buttons
            document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-blue-100', 'text-blue-800');
            });
            // Add active class to the selected button
            const activeBtn = categoriesContainer.querySelector(`[data-category-id="${categoryId}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-blue-100', 'text-blue-800');
                activeBtn.classList.add('bg-blue-600', 'text-white');
            }
            renderItems(categoryId);
        }

        /**
         * Adds an item to the current order or increments its quantity.
         * @param {Object} item - The item object to add.
         */
        function addItemToOrder(item) {
            const existingItemIndex = currentOrder.findIndex(orderItem => orderItem.id === item.id);
            if (existingItemIndex > -1) {
                currentOrder[existingItemIndex].quantity++;
            } else {
                currentOrder.push({ ...item, quantity: 1 });
            }
            renderOrder();
        }

        /**
         * Renders the current order list and updates summary totals.
         */
        function renderOrder() {
            orderList.innerHTML = '';
            if (currentOrder.length === 0) {
                emptyOrderMessage.style.display = 'block';
            } else {
                emptyOrderMessage.style.display = 'none';
                currentOrder.forEach(orderItem => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0';
                    itemElement.innerHTML = `
                        <div class="flex-1">
                            <span class="font-medium text-gray-800">${orderItem.name}</span>
                            <span class="text-sm text-gray-500 block">($${orderItem.price.toFixed(2)} each)</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="qty-btn bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300 transition-colors" data-id="${orderItem.id}" data-action="decrement">-</button>
                            <span class="font-bold text-gray-800 w-6 text-center">${orderItem.quantity}</span>
                            <button class="qty-btn bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300 transition-colors" data-id="${orderItem.id}" data-action="increment">+</button>
                            <span class="font-bold text-gray-900 w-16 text-right">$${(orderItem.price * orderItem.quantity).toFixed(2)}</span>
                            <button class="remove-item-btn text-red-500 hover:text-red-700 transition-colors ml-2" data-id="${orderItem.id}"><i class="fas fa-times-circle"></i></button>
                        </div>
                    `;
                    orderList.appendChild(itemElement);
                });
            }
            updateOrderSummary();
        }

        /**
         * Handles quantity changes and item removal from the order.
         * @param {Event} event - The click event.
         */
        orderList.addEventListener('click', (event) => {
            const target = event.target.closest('button');
            if (!target) return;

            const itemId = target.dataset.id;
            if (!itemId) return;

            const itemIndex = currentOrder.findIndex(item => item.id === itemId);
            if (itemIndex === -1) return;

            if (target.classList.contains('qty-btn')) {
                const action = target.dataset.action;
                if (action === 'increment') {
                    currentOrder[itemIndex].quantity++;
                } else if (action === 'decrement') {
                    currentOrder[itemIndex].quantity--;
                    if (currentOrder[itemIndex].quantity <= 0) {
                        currentOrder.splice(itemIndex, 1);
                    }
                }
            } else if (target.classList.contains('remove-item-btn')) {
                currentOrder.splice(itemIndex, 1);
            }
            renderOrder();
        });

        /**
         * Updates the order summary (subtotal, tax, grand total).
         */
        function updateOrderSummary() {
            let subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let tax = subtotal * TAX_RATE;
            let grandTotal = subtotal + tax;

            subtotalElem.textContent = `$${subtotal.toFixed(2)}`;
            taxAmountElem.textContent = `$${tax.toFixed(2)}`;
            grandTotalElem.textContent = `$${grandTotal.toFixed(2)}`;
        }

        /**
         * Processes the payment, records the sale, and resets the order.
         */
        processPaymentBtn.addEventListener('click', async () => {
            const total = parseFloat(grandTotalElem.textContent.replace('$', ''));

            if (currentOrder.length === 0) {
                showMessageModal("Payment Error", "Please add items to the order first.");
                return;
            }

            try {
                // Record the sale
                const transaction = {
                    id: crypto.randomUUID(), // Unique ID for local storage
                    timestamp: new Date().toISOString(),
                    cashierId: userId, // The logged-in user's ID
                    total: total,
                    paymentMethod: "Exact Amount", // Keep paymentMethod for potential future use
                    items: currentOrder.map(item => ({
                        itemId: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        categoryId: item.categoryId // Include categoryId for sales summary by category
                    }))
                };

                if (USE_LOCAL_STORAGE) {
                    salesHistory.push(transaction);
                    saveSalesHistory();
                    showMessageModal("Payment Successful!", `Total Paid: $${total.toFixed(2)} (Saved Locally)`);
                } else {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                    await addDoc(collection(db, `artifacts/${appId}/public/data/salesHistory`), transaction);
                    showMessageModal("Payment Successful!", `Total Paid: $${total.toFixed(2)} (Saved to Firestore)`);
                }
                resetPOS();
            }
            catch (error) {
                console.error("Error processing payment:", error);
                showMessageModal("Payment Failed", "Could not record the transaction. Please try again.");
            }
        });

        /**
         * Clears the current order and resets POS state.
         */
        cancelOrderBtn.addEventListener('click', async () => {
            const confirmed = await showConfirmModal("Cancel Order", "Are you sure you want to cancel the current order?");
            if (confirmed) {
                resetPOS();
                showMessageModal("Order Canceled", "The current order has been cleared.");
            }
        });

        /**
         * Resets the POS to its initial state.
         */
        function resetPOS() {
            currentOrder = [];
            renderOrder();
        }


        // --- UI Section Management Functions ---

        /**
         * Switches between home, POS, and Admin sections and manages navigation button visibility.
         * @param {string} sectionId - 'home', 'pos' or 'admin'.
         */
        function showSection(sectionId) {
            homePageSection.classList.add('hidden');
            posSection.classList.add('hidden');
            adminSection.classList.add('hidden');

            // Hide all nav buttons and logout button by default
            posNavBtn.classList.add('hidden');
            adminNavBtn.classList.add('hidden');
            logoutBtn.classList.add('hidden');

            // Remove active state from all nav buttons
            posNavBtn.classList.remove('bg-gray-700');
            adminNavBtn.classList.remove('bg-gray-700');

            if (sectionId === 'home') {
                homePageSection.classList.remove('hidden');
                document.getElementById('current-user-id').textContent = 'Not logged in';
                userSelect.value = ''; // Reset dropdown
                passwordInput.value = ''; // Clear password
            } else if (sectionId === 'pos') {
                posSection.classList.remove('hidden');
                posNavBtn.classList.remove('hidden'); // Show POS nav button
                posNavBtn.classList.add('bg-gray-700'); // Mark active
                logoutBtn.classList.remove('hidden'); // Show logout button
                renderCategories();
                renderItems();
                renderOrder();
                if (userRole === 'admin') { // Admin also sees Admin Panel nav button
                    adminNavBtn.classList.remove('hidden');
                }
            } else if (sectionId === 'admin') {
                // Only allow admin to view this section
                if (userRole === 'admin') {
                    adminSection.classList.remove('hidden');
                    posNavBtn.classList.remove('hidden'); // Admin always sees POS nav button
                    adminNavBtn.classList.remove('hidden'); // Show Admin nav button
                    adminNavBtn.classList.add('bg-gray-700'); // Mark active
                    logoutBtn.classList.remove('hidden'); // Show logout button
                    showAdminSubSection('manage-items'); // Default to Manage Items tab
                } else {
                    showMessageModal("Access Denied", "You do not have permission to view the Admin Panel.");
                    // If a cashier tries to access admin, redirect them back to POS
                    showSection('pos');
                }
            }
        }

        /**
         * Switches between admin sub-sections (Manage Items, Manage Categories, Sales History).
         * @param {string} subSectionId - 'manage-items', 'manage-categories', or 'sales-history'.
         */
        function showAdminSubSection(subSectionId) {
            manageItemsSection.classList.add('hidden');
            manageCategoriesSection.classList.add('hidden');
            salesHistorySection.classList.add('hidden');

            // Remove active styling from all tabs
            manageItemsTab.classList.remove('border-blue-500', 'text-gray-900');
            manageCategoriesTab.classList.remove('border-blue-500', 'text-gray-900');
            salesHistoryTab.classList.remove('border-blue-500', 'text-gray-900');
            manageItemsTab.classList.add('text-gray-600', 'hover:text-gray-900', 'border-transparent', 'hover:border-blue-500');
            manageCategoriesTab.classList.add('text-gray-600', 'hover:text-gray-900', 'border-transparent', 'hover:border-blue-500');
            salesHistoryTab.classList.add('text-gray-600', 'hover:text-gray-900', 'border-transparent', 'hover:border-blue-500');


            // Show the selected section and add active styling to its tab
            if (subSectionId === 'manage-items') {
                manageItemsSection.classList.remove('hidden');
                manageItemsTab.classList.remove('text-gray-600', 'hover:text-gray-900', 'border-transparent', 'hover:border-blue-500');
                manageItemsTab.classList.add('border-blue-500', 'text-gray-900');
                renderAdminItems(); // Ensure items are rendered when this tab is selected
                populateNewItemCategorySelect(); // Ensure category dropdown is populated
            } else if (subSectionId === 'manage-categories') {
                manageCategoriesSection.classList.remove('hidden');
                manageCategoriesTab.classList.remove('text-gray-600', 'hover:text-gray-900', 'border-transparent', 'hover:border-blue-500');
                manageCategoriesTab.classList.add('border-blue-500', 'text-gray-900');
                renderAdminCategories(); // Ensure categories are rendered when this tab is selected
            } else if (subSectionId === 'sales-history') {
                salesHistorySection.classList.remove('hidden');
                salesHistoryTab.classList.remove('text-gray-600', 'hover:text-gray-900', 'border-transparent', 'hover:border-blue-500');
                salesHistoryTab.classList.add('border-blue-500', 'text-gray-900');
                renderSalesHistory(); // Re-render history on tab switch
            }
        }


        // Event Listeners for Nav Buttons
        posNavBtn.addEventListener('click', () => showSection('pos'));
        adminNavBtn.addEventListener('click', () => showSection('admin'));
        logoutBtn.addEventListener('click', () => {
            // Confirm logout
            showConfirmModal("Logout Confirmation", "Are you sure you want to log out?").then(confirmed => {
                if (confirmed) {
                    logout();
                }
            });
        });

        // Event listener for the new login button
        loginBtn.addEventListener('click', () => {
            const selectedUser = userSelect.value; // Get selected username from dropdown
            const password = passwordInput.value.trim();

            loginErrorMessage.classList.add('hidden'); // Hide previous error

            if (selectedUser === CASHIER_USERNAME && password === CASHIER_PASSWORD) {
                userId = CASHIER_USERNAME;
                userRole = 'cashier';
                localStorage.setItem('pos_user_id', userId);
                document.getElementById('current-user-id').textContent = userId + (USE_LOCAL_STORAGE ? " (Local)" : "");
                showSection('pos'); // Show POS section for cashier
            } else if (selectedUser === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                userId = ADMIN_USERNAME;
                userRole = 'admin';
                localStorage.setItem('pos_user_id', userId);
                document.getElementById('current-user-id').textContent = userId + (USE_LOCAL_STORAGE ? " (Local)" : "");
                showSection('admin'); // Show Admin section for admin
            } else {
                loginErrorMessage.classList.remove('hidden'); // Show error
            }
        });

        /**
         * Logs out the current user and returns to the login screen.
         */
        function logout() {
            userId = 'unauthenticated';
            userRole = 'guest';
            localStorage.removeItem('pos_user_id'); // Clear user ID from local storage
            showSection('home');
            showMessageModal("Logged Out", "You have been successfully logged out.");
        }

        // Allow pressing Enter key for password input to login
        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                loginBtn.click();
            }
        });


        // Event Listeners for Admin Tabs
        manageItemsTab.addEventListener('click', () => showAdminSubSection('manage-items'));
        manageCategoriesTab.addEventListener('click', () => showAdminSubSection('manage-categories'));
        salesHistoryTab.addEventListener('click', () => showAdminSubSection('sales-history'));

        /**
         * Populates the category dropdown for adding new items in the admin panel.
         */
        function populateNewItemCategorySelect() {
            newItemCategorySelect.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                newItemCategorySelect.appendChild(option);
            });
        }

        /**
         * Renders the list of items in the admin panel for editing/deleting.
         */
        function renderAdminItems() {
            adminItemsList.innerHTML = '';
            if (items.length === 0) {
                adminItemsList.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No items available.</td></tr>';
                return;
            }

            items.forEach(item => {
                const categoryName = categories.find(cat => cat.id === item.categoryId)?.name || 'Uncategorized';
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 whitespace-nowrap text-gray-800">${item.name}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-gray-600">${categoryName}</td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <input type="number" value="${item.price.toFixed(2)}" class="admin-item-price-input p-1 border border-gray-300 rounded-md w-24 text-gray-800" data-id="${item.id}" min="0.01" step="0.01">
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <button class="edit-item-btn text-blue-600 hover:text-blue-800 mr-2" data-id="${item.id}" title="Save Changes"><i class="fas fa-save"></i></button>
                        <button class="delete-item-btn text-red-600 hover:text-red-800" data-id="${item.id}" title="Delete Item"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                adminItemsList.appendChild(row);
            });

            // Add event listeners for price input and action buttons
            adminItemsList.querySelectorAll('.admin-item-price-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    // This change triggers the save button, which then applies the update
                });
            });
            adminItemsList.querySelectorAll('.edit-item-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const itemId = e.currentTarget.dataset.id;
                    const priceInput = e.currentTarget.closest('tr').querySelector('.admin-item-price-input');
                    const newPrice = parseFloat(priceInput.value);

                    if (isNaN(newPrice) || newPrice <= 0) {
                        showMessageModal("Invalid Price", "Please enter a valid price for the item.");
                        priceInput.value = items.find(i => i.id === itemId).price.toFixed(2); // Revert
                        return;
                    }
                    try {
                        if (USE_LOCAL_STORAGE) {
                            const itemIndex = items.findIndex(item => item.id === itemId);
                            if (itemIndex > -1) {
                                items[itemIndex].price = newPrice;
                                saveItems();
                                showMessageModal("Success", "Item price updated successfully (locally)!");
                            }
                        } else {
                            const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                            await updateDoc(doc(db, `artifacts/${appId}/public/data/items`, itemId), { price: newPrice });
                            showMessageModal("Success", "Item price updated successfully (Firestore)!");
                        }
                    } catch (error) {
                        console.error("Error updating item price:", error);
                        showMessageModal("Error", "Failed to update item price. Please try again.");
                    }
                });
            });
            adminItemsList.querySelectorAll('.delete-item-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const itemId = e.currentTarget.dataset.id;
                    const confirmed = await showConfirmModal("Delete Item", "Are you sure you want to delete this item?");
                    if (confirmed) {
                        try {
                            if (USE_LOCAL_STORAGE) {
                                items = items.filter(item => item.id !== itemId);
                                saveItems();
                                showMessageModal("Success", "Item deleted successfully (locally)!");
                                renderItems(); // Re-render POS menu after local deletion
                                renderAdminItems(); // Re-render admin list
                            } else {
                                const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/items`, itemId));
                                showMessageModal("Success", "Item deleted successfully (Firestore)!");
                            }
                        } catch (error) {
                            console.error("Error deleting item:", error);
                            showMessageModal("Error", "Failed to delete item. Please try again.");
                        }
                    }
                });
            });
        }

        /**
         * Handles adding a new item.
         */
        addItemBtn.addEventListener('click', async () => {
            const name = newItemNameInput.value.trim();
            const price = parseFloat(newItemPriceInput.value);
            const categoryId = newItemCategorySelect.value;

            if (!name || isNaN(price) || price <= 0 || !categoryId) {
                showMessageModal("Input Error", "Please fill in all item details (Name, valid Price, and Category).");
                return;
            }

            try {
                const newItem = {
                    name: name,
                    price: price,
                    categoryId: categoryId,
                    image: '' // Placeholder, could be extended later
                };

                if (USE_LOCAL_STORAGE) {
                    newItem.id = crypto.randomUUID(); // Assign a unique ID for local storage
                    items.push(newItem);
                    saveItems();
                    showMessageModal("Success", "Item added successfully (locally)!");
                } else {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                    await addDoc(collection(db, `artifacts/${appId}/public/data/items`), newItem);
                    showMessageModal("Success", "Item added successfully (Firestore)!");
                }
                newItemNameInput.value = '';
                newItemPriceInput.value = '';
                newItemCategorySelect.value = '';
            } catch (error) {
                console.error("Error adding item:", error);
                showMessageModal("Error", "Failed to add item. Please try again.");
            }
        });


        /**
         * Renders the list of categories in the admin panel for editing/deleting.
         */
        function renderAdminCategories() {
            adminCategoriesList.innerHTML = '';
            if (categories.length === 0) {
                adminCategoriesList.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">No categories available.</td></tr>';
                return;
            }

            categories.forEach(category => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 whitespace-nowrap text-gray-800">${category.name}</td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <button class="edit-category-btn text-blue-600 hover:text-blue-800 mr-2" data-id="${category.id}" data-name="${category.name}" title="Edit Category"><i class="fas fa-edit"></i></button>
                        <button class="delete-category-btn text-red-600 hover:text-red-800" data-id="${category.id}" title="Delete Category"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                adminCategoriesList.appendChild(row);
            });

            adminCategoriesList.querySelectorAll('.edit-category-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const categoryId = e.currentTarget.dataset.id;
                    const oldName = e.currentTarget.dataset.name;
                    const newName = prompt(`Edit category name for "${oldName}":`, oldName);

                    if (newName && newName.trim() !== oldName) {
                        try {
                            if (USE_LOCAL_STORAGE) {
                                const categoryIndex = categories.findIndex(cat => cat.id === categoryId);
                                if (categoryIndex > -1) {
                                    categories[categoryIndex].name = newName.trim();
                                    saveCategories();
                                    showMessageModal("Success", "Category name updated (locally)!");
                                    renderCategories(); // Re-render POS categories
                                    renderAdminCategories(); // Re-render admin list
                                    populateNewItemCategorySelect(); // Update select dropdown
                                }
                            } else {
                                const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                                await updateDoc(doc(db, `artifacts/${appId}/public/data/categories`, categoryId), { name: newName.trim() });
                                showMessageModal("Success", "Category name updated (Firestore)!");
                            }
                        }
                        catch (error) {
                            console.error("Error updating category:", error);
                            showMessageModal("Error", "Failed to update category. Please try again.");
                        }
                    }
                });
            });

            adminCategoriesList.querySelectorAll('.delete-category-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const categoryId = e.currentTarget.dataset.id;
                    // Check if any items are linked to this category
                    const linkedItems = items.filter(item => item.categoryId === categoryId);
                    if (linkedItems.length > 0) {
                        showMessageModal("Cannot Delete", `This category has ${linkedItems.length} item(s) linked to it. Please reassign or delete those items first.`);
                        return;
                    }

                    const confirmed = await showConfirmModal("Delete Category", "Are you sure you want to delete this category? This action cannot be undone.");
                    if (confirmed) {
                        try {
                            if (USE_LOCAL_STORAGE) {
                                categories = categories.filter(category => category.id !== categoryId);
                                saveCategories();
                                showMessageModal("Success", "Category deleted successfully (locally)!");
                                renderCategories(); // Re-render POS categories
                                renderAdminCategories(); // Re-render admin list
                                populateNewItemCategorySelect(); // Update select dropdown
                            } else {
                                const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/categories`, categoryId));
                                showMessageModal("Success", "Category deleted successfully (Firestore)!");
                            }
                        } catch (error) {
                            console.error("Error deleting category:", error);
                            showMessageModal("Error", "Failed to delete category. Please try again.");
                        }
                    }
                });
            });
        }

        /**
         * Handles adding a new category.
         */
        addCategoryBtn.addEventListener('click', async () => {
            const name = newCategoryNameInput.value.trim();
            if (!name) {
                showMessageModal("Input Error", "Category name cannot be empty.");
                return;
            }

            try {
                const newCategory = { name: name };
                if (USE_LOCAL_STORAGE) {
                    newCategory.id = crypto.randomUUID(); // Assign a unique ID for local storage
                    categories.push(newCategory);
                    saveCategories();
                    showMessageModal("Success", "Category added successfully (locally)!");
                } else {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                    await addDoc(collection(db, `artifacts/${appId}/public/data/categories`), newCategory);
                    showMessageModal("Success", "Category added successfully (Firestore)!");
                }
                newCategoryNameInput.value = '';
            } catch (error) {
                console.error("Error adding category:", error);
                showMessageModal("Error", "Failed to add category. Please try again.");
            }
        });


        /**
         * Renders the sales history table and updates total sales based on filters.
         */
        function renderSalesHistory() {
            salesHistoryList.innerHTML = '';
            totalSalesDisplay.textContent = '$0.00'; // Reset total sales display
            itemSalesSummaryList.innerHTML = ''; // Clear item summary too

            let filteredHistory = [...salesHistory]; // Create a mutable copy

            const startDate = historyStartDateInput.value ? new Date(historyStartDateInput.value) : null;
            const endDate = historyEndDateInput.value ? new Date(historyEndDateInput.value) : null;
            const cashierFilter = historyCashierFilterInput.value.trim().toLowerCase();

            filteredHistory = filteredHistory.filter(transaction => {
                const transactionDate = new Date(transaction.timestamp);
                let passDateFilter = true;
                if (startDate && transactionDate < startDate) {
                    passDateFilter = false;
                }
                if (endDate && transactionDate > endDate) {
                    // Adjust end date to include the whole day
                    const endOfDay = new Date(endDate);
                    endOfDay.setHours(23, 59, 59, 999);
                    if (transactionDate > endOfDay) {
                        passDateFilter = false;
                    }
                }

                let passCashierFilter = true;
                // Only filter by cashier ID if it's not empty and the transaction has a cashierId
                if (cashierFilter && transaction.cashierId && !transaction.cashierId.toLowerCase().includes(cashierFilter)) {
                    passCashierFilter = false;
                }

                return passDateFilter && passCashierFilter;
            });

            // Calculate overall total sales for the filtered history
            const overallTotalSales = filteredHistory.reduce((sum, transaction) => sum + transaction.total, 0);
            totalSalesDisplay.textContent = `$${overallTotalSales.toFixed(2)}`;

            // Sort history by timestamp (most recent first)
            filteredHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (filteredHistory.length === 0) {
                salesHistoryList.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No sales transactions match the filters.</td></tr>';
            } else {
                filteredHistory.forEach(transaction => {
                    const transactionDate = new Date(transaction.timestamp).toLocaleString();
                    const itemsSummary = transaction.items.map(item => `${item.name} (x${item.quantity})`).join(', ');

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4 whitespace-nowrap text-gray-800">${transactionDate}</td>
                        <td class="py-3 px-4 whitespace-nowrap text-green-700 font-bold">$${transaction.total.toFixed(2)}</td>
                        <td class="py-3 px-4 text-gray-600 text-sm max-w-xs overflow-hidden text-ellipsis whitespace-nowrap" title="${itemsSummary}">${itemsSummary}</td>
                    `;
                    salesHistoryList.appendChild(row);
                });
            }

            // After rendering individual sales, render the item sales summary with total items sold
            renderItemSalesSummary(filteredHistory);
        }

        /**
         * Renders the sales summary aggregated by item, showing total items sold.
         * @param {Array<Object>} salesData - The filtered sales data to summarize.
         */
        function renderItemSalesSummary(salesData) {
            itemSalesSummaryList.innerHTML = ''; // Clear previous data

            const itemCounts = {};

            salesData.forEach(transaction => {
                transaction.items.forEach(item => {
                    const itemName = item.name;
                    
                    if (itemCounts[itemName]) {
                        itemCounts[itemName] += item.quantity;
                    } else {
                        itemCounts[itemName] = item.quantity;
                    }
                });
            });

            // Sort items by name
            const sortedItems = Object.keys(itemCounts).sort();

            if (sortedItems.length === 0) {
                itemSalesSummaryList.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">No item sales data.</td></tr>';
                return;
            }

            sortedItems.forEach(itemName => {
                const totalQuantity = itemCounts[itemName];
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 whitespace-nowrap text-gray-800">${itemName}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-blue-700 font-bold">${totalQuantity} items</td>
                `;
                itemSalesSummaryList.appendChild(row);
            });
        }

        // Event listener for applying filters
        applyHistoryFilterBtn.addEventListener('click', renderSalesHistory);

        // Event listener for clearing sales history
        clearSalesHistoryBtn.addEventListener('click', async () => {
            const confirmed = await showConfirmModal(
                "Clear Sales History",
                "Are you sure you want to clear ALL sales history? This action cannot be undone."
            );

            if (confirmed) {
                try {
                    if (USE_LOCAL_STORAGE) {
                        salesHistory = []; // Clear array
                        saveSalesHistory(); // Save empty array to local storage
                        showMessageModal("Success", "Sales history cleared successfully (locally)!");
                    } else {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                        const salesCollectionRef = collection(db, `artifacts/${appId}/public/data/salesHistory`);
                        const querySnapshot = await getDocs(salesCollectionRef);
                        
                        // Delete each document in the collection
                        const batch = [];
                        querySnapshot.forEach((doc) => {
                            batch.push(deleteDoc(doc.ref));
                        });
                        await Promise.all(batch); // Execute all deletes concurrently
                        showMessageModal("Success", "Sales history cleared successfully (Firestore)!");
                    }
                    renderSalesHistory(); // Re-render to show empty state
                } catch (error) {
                    console.error("Error clearing sales history:", error);
                    showMessageModal("Error", "Failed to clear sales history. Please try again.");
                }
            }
        });

        // Event listener for exporting to PDF
        exportPdfBtn.addEventListener('click', async () => {
            try {
                // Temporarily disable the export button to prevent multiple clicks
                exportPdfBtn.disabled = true;
                exportPdfBtn.textContent = 'Generating PDF...';

                // Get the sales history section element
                const salesHistoryContent = document.getElementById('sales-history-section');

                // Use html2canvas to render the sales history section as an image
                const canvas = await html2canvas(salesHistoryContent, {
                    scale: 2, // Increase scale for better resolution in PDF
                    useCORS: true, // If there are external images, ensure CORS is handled
                    logging: false // Disable logging if not debugging
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' for A4 size

                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // Add the image to the PDF
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // If content spans multiple pages, add new pages
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save('sales_history.pdf');
                showMessageModal("PDF Export Successful", "Sales history has been exported to sales_history.pdf");

            } catch (error) {
                console.error("Error generating PDF:", error);
                showMessageModal("PDF Export Failed", "Could not generate PDF. Please try again. Ensure all content is visible on screen.");
            } finally {
                // Re-enable the export button
                exportPdfBtn.disabled = false;
                exportPdfBtn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i> Save to PDF';
            }
        });

        /**
         * Seeds initial data (categories and items) if collections are empty.
         * @param {string} [appId] - Optional appId for Firebase paths.
         */
        async function seedInitialData(appId = 'default-app-id') { // Default to 'default-app-id' for local storage
            let categoriesToSeed = [];
            let itemsToSeed = [];

            if (USE_LOCAL_STORAGE) {
                loadCategories();
                loadItems();
                if (categories.length === 0 && items.length === 0) {
                    console.log("Local Storage is empty, seeding initial categories and items...");
                    categoriesToSeed = DEFAULT_CATEGORIES.map(cat => ({ ...cat, id: crypto.randomUUID() }));
                    categories.push(...categoriesToSeed);
                    saveCategories();

                    const categoryIdMap = categoriesToSeed.reduce((map, cat) => {
                        map[cat.name] = cat.id;
                        return map;
                    }, {});

                    itemsToSeed = DEFAULT_ITEMS.map(item => ({
                        ...item,
                        id: crypto.randomUUID(),
                        categoryId: categoryIdMap[item.category] || 'uncategorized'
                    }));
                    items.push(...itemsToSeed);
                    saveItems();
                    console.log("Initial data seeding complete (Local Storage).");
                } else {
                    console.log("Local Storage already contains data, skipping initial seeding.");
                }
            } else {
                // Firebase seeding logic
                if (!db) {
                    console.error("Firestore DB not initialized. Cannot seed data.");
                    return;
                }

                const categoriesCollectionRef = collection(db, `artifacts/${appId}/public/data/categories`);
                const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/items`);

                const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                if (categoriesSnapshot.empty) {
                    console.log("Firestore categories collection is empty, seeding initial categories and items...");

                    const categoryIdMap = {};
                    for (const category of DEFAULT_CATEGORIES) {
                        const docRef = await addDoc(categoriesCollectionRef, category);
                        categoryIdMap[category.name] = docRef.id;
                        console.log(`Added category: ${category.name} with ID: ${docRef.id}`);
                    }

                    for (const item of DEFAULT_ITEMS) {
                        const categoryId = categoryIdMap[item.category];
                        if (categoryId) {
                            await addDoc(itemsCollectionRef, {
                                name: item.name,
                                price: item.price,
                                categoryId: categoryId,
                                image: item.image || ''
                            });
                            console.log(`Added item: ${item.name} to category ${item.category}`);
                        } else {
                            console.warn(`Category '${item.category}' not found for item '${item.name}'. Skipping item.`);
                        }
                    }
                    console.log("Initial data seeding complete (Firestore).");
                } else {
                    console.log("Firestore categories collection not empty, skipping initial data seeding.");
                }
            }
        }
    </script>
</body>
</html>
